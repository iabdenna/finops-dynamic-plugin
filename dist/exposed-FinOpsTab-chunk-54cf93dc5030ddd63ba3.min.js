"use strict";(self.webpackChunkfinops_plugin=self.webpackChunkfinops_plugin||[]).push([[157],{139:(e,t,o)=>{o.r(t),o.d(t,{default:()=>c});var n=o(271),a=o(879);const r=e=>(e?.data?.result??[]).map((e=>{const t=Number(e?.value?.[1]);return Number.isFinite(t)?{container:e.metric?.container??"",workload:e.metric?.workload??"",workload_type:e.metric?.workload_type??"",value:t}:null})).filter(Boolean),l=e=>e/1024**3,i=e=>Math.max(0,Math.min(1,e)),s=({percent:e,color:t,usageGiBText:o,limitGiBText:a,percentText:r,statusText:l,statusColor:s})=>{const c=200,d=2*Math.PI*91,m=d*i(e),p=d-m;return n.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:12}},n.createElement("div",{style:{position:"relative",width:c,height:c}},n.createElement("svg",{width:c,height:c,viewBox:"0 0 200 200"},n.createElement("circle",{cx:100,cy:100,r:91,fill:"none",stroke:"#d2d2d2",strokeWidth:18}),n.createElement("circle",{cx:100,cy:100,r:91,fill:"none",stroke:t,strokeWidth:18,strokeLinecap:"round",strokeDasharray:`${m} ${p}`,transform:"rotate(-90 100 100)"})),n.createElement("div",{style:{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:8}},n.createElement("div",{style:{fontSize:28,fontWeight:800,color:"#151515"}},o),n.createElement("div",{style:{padding:"4px 10px",borderRadius:999,background:"#f5f5f5",border:`1px solid ${t}`,color:t,fontWeight:700,fontSize:12}},r))),n.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:6}},n.createElement("div",{style:{fontSize:14,color:"#6a6e73"}},"Limit: ",n.createElement("span",{style:{color:"#151515",fontWeight:700}},a)),n.createElement("div",{style:{padding:"2px 10px",borderRadius:999,background:"#ffffff",border:`1px solid ${s}`,color:s,fontWeight:800,fontSize:12,letterSpacing:.4}},l)))},c=({obj:e})=>{const t=e?.metadata?.namespace??"",o=e?.metadata?.name??"",{limitQuery:c,usageQuery:d}=n.useMemo((()=>(e=>({limitQuery:`\nmax by (container, namespace, workload_type, workload) (\n  kube_pod_container_resource_limits{resource="memory", namespace="${e}", container!=""}\n  * on(namespace, pod) group_left(workload, workload_type)\n  namespace_workload_pod:kube_pod_owner:relabel{\n    namespace="${e}",\n    workload_type=~"deployment|statefulset|daemonset"\n  }\n)\n`.trim(),usageQuery:`\nmax by (container, namespace, workload_type, workload) (\n  max_over_time(\n    container_memory_working_set_bytes{\n      namespace="${e}",\n      container!="",\n      container!="POD"\n    }[7d]\n  )\n  * on(namespace, pod) group_left(workload, workload_type)\n  namespace_workload_pod:kube_pod_owner:relabel{\n    namespace="${e}",\n    workload_type=~"deployment|statefulset|daemonset"\n  }\n)\n`.trim()}))(t)),[t]),[m,p,u]=(0,a.usePrometheusPoll)({endpoint:a.PrometheusEndpoint.QUERY,query:c,namespace:t,delay:6e4}),[y,f,g]=(0,a.usePrometheusPoll)({endpoint:a.PrometheusEndpoint.QUERY,query:d,namespace:t,delay:6e4}),k=n.useMemo((()=>r(m).filter((e=>"deployment"===e.workload_type&&e.workload===o))),[m,o]),x=n.useMemo((()=>r(y).filter((e=>"deployment"===e.workload_type&&e.workload===o))),[y,o]),h=n.useMemo((()=>{const e=new Map;k.forEach((t=>e.set(t.container,t.value)));const t=new Map;return x.forEach((e=>t.set(e.container,e.value))),Array.from(new Set([...e.keys(),...t.keys()])).sort().map((o=>{const n=e.get(o),a=t.get(o),r=void 0!==n?l(n):null,i=void 0!==a?l(a):null;return{container:o,limitGiB:r,usageGiB:i,ratio:null!==i&&null!==r&&r>0?i/r:null}}))}),[k,x]),w=u||g,_=Boolean(p||f);return n.createElement("div",{style:{padding:16}},n.createElement("h2",{style:{marginTop:0}},"FinOps"),n.createElement("div",{style:{color:"#6a6e73",marginBottom:12}},"Deployment ",n.createElement("b",null,o)," in namespace ",n.createElement("b",null,t)),_&&0===h.length&&n.createElement("div",{style:{color:"#c9190b",marginBottom:12}},"Prometheus query error"),w?n.createElement("div",{style:{padding:12}},"Loadingâ€¦"):0===h.length?n.createElement("div",{style:{padding:12}},"No data available for this Deployment"):n.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:24,alignItems:"flex-start"}},h.map((e=>{const t=null===e.ratio?0:i(e.ratio),o=null===(a=e.ratio)?"#6a6e73":a>=.9?"#c9190b":a>=.7?"#f0ab00":"#3e8635";var a;const r=(e=>null===e?{text:"N/A",color:"#6a6e73"}:e>=.9?{text:"CRITICAL",color:"#c9190b"}:e>=.7?{text:"WARNING",color:"#f0ab00"}:{text:"OK",color:"#3e8635"})(e.ratio),l=null!==e.usageGiB?`${e.usageGiB.toFixed(2)} GiB`:"N/A",c=null!==e.limitGiB?`${e.limitGiB.toFixed(2)} GiB`:"N/A",d=null!==e.ratio?`${Math.round(100*e.ratio)}%`:"N/A";return n.createElement("div",{key:e.container,style:{border:"1px solid #d2d2d2",borderRadius:12,padding:18,minWidth:340,background:"#fff"}},n.createElement("div",{style:{fontWeight:700,marginBottom:12,fontSize:14,color:"#151515"}},e.container),n.createElement(s,{percent:t,color:o,usageGiBText:l,limitGiBText:c,percentText:d,statusText:r.text,statusColor:r.color}))}))))}}}]);